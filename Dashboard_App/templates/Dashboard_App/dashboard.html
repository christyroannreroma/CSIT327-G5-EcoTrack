{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=0.8">
  <title>Dashboard ‚Äî EcoTrack</title>
  
  <!-- External Libraries -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Local Styles and Scripts -->
  <link rel="stylesheet" href="{% static 'Dashboard_App/dashboard.css' %}">
  <link rel="icon" type="image/x-icon" href="{% static 'Homepage_App/images/EcoTrack_Logo1.png' %}">
  <script>
    // Expose a small user object for client-side logic (no secrets)
    window.USER = {
      isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %},
      username: {% if user.is_authenticated %}"{{ user.username|escapejs }}"{% else %}null{% endif %}
    };
  </script>
</head>

<body>
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-top">
      <h2 class="sidebar-logo">EcoTrack</h2>
      <nav class="nav-links">
        <a href="{% url 'Dashboard_App:dashboard' %}" class="nav-item active">
          <span class="icon">üè†</span> Home
        </a>
        <a href="{% url 'Activity_App:activity' %}" class="nav-item">
          <span class="icon">‚ûï</span> Add Activity
        </a>
        <a href="{% url 'Challenges_App:challenges' %}" class="nav-item">
          <span class="icon">üèÜ</span> Challenges
        </a>
        <a href="{% url 'Recycling_App:recycling' %}" class="nav-item">
          <span class="icon">‚ôªÔ∏è</span> Recycling
        </a>
        <a href="{% url 'History_App:history' %}" class="nav-item">
          <span class="icon">üìú</span> History
        </a>
      </nav>
    </div>

    <div class="sidebar-bottom">
      <a href="#" class="nav-item" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Log out
      </a>
    </div>
  </aside>

  <!-- Main Dashboard Content -->
  <div class="dashboard">
    <header>
      <div class="logo">
        <img src="{% static 'Homepage_App/images/EcoTrack_Logo1.png' %}" alt="EcoTrack" style="height: 60px; width: 120px;">
      </div>
      <div class="user-profile" id="userProfile">
        <div class="avatar">
          {% if user.is_authenticated %}
            {{ user.username|slice:":2"|upper }}
          {% else %}
            Guest
          {% endif %}
        </div>
        <span>
          {% if user.is_authenticated %}
            {{ user.get_full_name|default:user.username }}
          {% else %}
            Guest
          {% endif %}
        </span>
        <i class="fas fa-chevron-down"></i>
        <div class="profile-menu" id="profileMenu">
          <div class="profile-menu-item">
            <a href="{% url 'Profile_App:profile' %}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-user"></i>
            <span>My Profile</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <h1 class="welcome-text">üåøWelcome, 
      {% if user.is_authenticated %}
          {{ user.get_full_name|default:user.username }}!
      {% else %}
          Guest!
      {% endif %}
    </h1>
    <br/>
    
    <div class="dashboard-grid">
      <div class="left-column">
        <!-- Carbon Footprint Score -->
        <div class="card score-card">
          <h2 style="text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);">‚≠ê Your Daily Carbon Footprint Score ‚≠ê</h2>
          <div class="score-value" id="scoreValue">0.0</div>
          <div class="score-label" id="scoreLabel">kg CO2</div>
          <div class="score-description" id="scoreResetMsg" style="font-size:1em;margin-top:4px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.2);font-weight:600;">Your Daily Score will reset in</div>
          <div class="score-timer" id="scoreTimer" style="font-size:1.2em;margin-top:2px;color:#f5f5f5;text-shadow:0 1px 2px rgba(0,0,0,0.2);">Next reset: 24:00:00</div>
          <div class="score-warning" id="scoreWarning" style="font-size:1.1em;margin-top:8px;font-weight:700;"></div>
          <div class="trend-indicator trend-down" id="trendIndicator" style="display:none;">
            <i class="fas fa-arrow-down"></i>
            <span id="trendText">Trending down this week</span>
          </div>
        </div>
        
        <!-- Chart (Doughnut Graph) -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Carbon Breakdown</h3>
            <i class="fas fa-chart-pie"></i>
          </div>
          <div class="chart-container">
            <canvas id="carbonChart"></canvas>
          </div>
        </div>
        
        <!-- Chart Details -->
        <div class="chart-details">
          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-car"></i>
            </div>
            <div class="detail-text">
              <div class="detail-label">Transportation</div>
            </div>
            <div class="detail-value" id="transportValue">0%</div>
          </div>
          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-utensils"></i>
            </div>
            <div class="detail-text">
              <div class="detail-label">Food</div>
            </div>
            <div class="detail-value" id="dietValue">0%</div>
          </div>
          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-bolt"></i>
            </div>
            <div class="detail-text">
              <div class="detail-label">Energy</div>
            </div>
            <div class="detail-value" id="energyValue">0%</div>
          </div>
        </div>
      </div>
      
      <!-- Right Column -->
      <div class="right-column">
        <!-- Daily Target -->
        <div class="card-right">
          <div class="card-header">
            <h3 class="card-title">Total Carbon Footprint Over Time</h3>
            <i class="fas fa-chart-line"></i>
          </div>
          <div style="margin-bottom: 10px;">
            <label for="cfTimeRange" style="font-weight:600;">View by:</label>
            <select id="cfTimeRange" style="margin-left:8px;">
              <option value="yearly">Year</option>
              <option value="monthly">Month</option>
              <option value="weekly">Week</option>
              <option value="daily">Day</option>
            </select>
          </div>
          <div class="chart-container">
            <canvas id="cfLineChart" height="120"></canvas>
          </div>
        </div>
        
        <!-- Badges -->
        <div class="card-right">
          <div class="card-header">
            <h3 class="card-title">Earned Badges</h3>
            <i class="fas fa-award"></i>
          </div>
          <div class="badges-container">
            <div class="badge {% if badges_context.eco_commuter.earned %}badge-unlocked{% else %}locked{% endif %}" id="badge-eco_commuter" data-badge="eco_commuter" data-prereq="Take 5 bike/walk trips or accumulate 50 km by bike/walk">
              <img src="{% static 'Homepage_App/images/Bike_Badge.svg' %}" alt="Eco Commuter Badge" class="icon-svg">
              <div class="badge-tooltip">Eco Commuter<br><small class="prereq">Prereq: Take 5 bike/walk trips or 50 km</small></div>
            </div>
            <div class="badge {% if badges_context.green_eater.earned %}badge-unlocked{% else %}locked{% endif %}" id="badge-green_eater" data-badge="green_eater" data-prereq="Log 7 vegetarian/vegan meals">
              <img src="{% static 'Homepage_App/images/GreenEater_Badge.svg' %}" alt="Green Eater Badge" class="icon-svg">
              <div class="badge-tooltip">Green Eater<br><small class="prereq">Prereq: 7 veg/vegan meals</small></div>
            </div>
            <!-- <div class="badge locked" id="badge-recycling_champion" data-badge="recycling_champion" data-prereq="Record 5 recycling actions (shopping note includes 'recycle')">
              <i class="fas fa-recycle"></i>
              <div class="badge-tooltip">Recycling Champion<br><small class="prereq">Prereq: 5 recycling actions</small></div>
            </div> -->
            <div class="badge {% if badges_context.energy_saver.earned %}badge-unlocked{% else %}locked{% endif %}" id="badge-energy_saver" data-badge="energy_saver" data-prereq="Use renewable energy 5 times or log low energy usage">
              <img src="{% static 'Homepage_App/images/EnergySaver_Badge.svg' %}" alt="Energy Saver Badge" class="icon-svg">
              <div class="badge-tooltip">Energy Saver<br><small class="prereq">Prereq: 5 renewable energy uses</small></div>
            </div>
            <div class="badge {% if badges_context.carbon_neutral.earned %}badge-unlocked{% else %}locked{% endif %}" id="badge-carbon_neutral" data-badge="carbon_neutral" data-prereq="Achieve total footprint ‚â§ 0.5 kg CO2">
              <img src="{% static 'Homepage_App/images/CarbonNeutral_Badge.svg' %}" alt="Carbon Neutral Badge" class="icon-svg">
              <div class="badge-tooltip">Carbon Neutral<br><small class="prereq">Prereq: Total ‚â§ 0.5 kg CO2</small></div>
            </div>
          </div>
        </div>
        
        <!-- Tips & Resources -->
        <div class="card-right">
          <div class="card-header">
            <h3 class="card-title">Tips & Resources</h3>
            <i class="fas fa-lightbulb"></i>
          </div>
          <ul class="activity-list">
            <li class="activity-item">
              <div class="activity-category">
                <i class="fas fa-seedling" style="color: var(--primary-green);"></i>
                <span>Try meat-free Mondays</span>
              </div>
            </li>
            <li class="activity-item">
              <div class="activity-category">
                <i class="fas fa-bus" style="color: var(--primary-green);"></i>
                <span>Use public transport twice this week</span>
              </div>
            </li>
            <li class="activity-item">
              <div class="activity-category">
                <i class="fas fa-plug" style="color: var(--primary-green);"></i>
                <span>Unplug devices when not in use</span>
              </div>
            </li>
            <li class="activity-item">
              <div class="activity-category">
                <i class="fas fa-droplet" style="color: var(--primary-green);"></i>
                <span>Turn off the taps when not in use</span>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    
    <!-- Recent Activities - Full Width Section -->
    <div class="card-activities full-width-section">
      <div class="card-header">
        <h3 class="card-title">Recent Activities</h3>
        <i class="fas fa-history"></i>
      </div>
      <ul class="activity-list" id="recentActivities">
        <!-- populated by JS -->
      </ul>
      <div class="history-button-wrapper" style="text-align: center; padding: 12px 0;">
        <a href="{% url 'History_App:history' %}" class="btn-history" style="display:inline-block; padding:10px 16px; background:var(--primary-green); color:white; border-radius:10px; text-decoration:none; font-weight:600;">View full history</a>
      </div>
    </div>
  </div>

  <div class="notification" id="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notificationText">Activity added successfully!</span>
  </div>

  <!-- Logout Confirmation Modal -->
  <div class="modal" id="logoutModal" style="display: none;">
    <div class="modal-content logout-modal">
      <div class="logout-icon">
        <i class="fas fa-sign-out-alt"></i>
      </div>
      <h3>Ready to leave?</h3>
      <p>You'll need to sign in again to access your dashboard.</p>
      <div class="logout-actions">
        <button class="btn-logout-cancel">Stay Signed In</button>
        <a href="{% url 'Login_App:logout' %}" class="btn-logout-confirm">
          <i class="fas fa-sign-out-alt"></i>
          Yes, Log Out
        </a>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Initial data from server (breakdown totals and recent activities)
    window.INIT_DATA = {{ init_data_json|safe }};
  </script>
  <script src="{% static 'Dashboard_App/dashboard.js' %}"></script>
  <script>
    (function() {
      // Bind logout modal handlers once for the Dashboard page
      var logoutLinks = Array.from(document.querySelectorAll('a[href*="logout"]'));
      var modal = document.getElementById('logoutModal');

      if (!modal) {
        logoutLinks.forEach(function(a){
          if (a.classList && a.classList.contains('btn-logout-confirm')) return;
          a.addEventListener('click', function(e){ e.preventDefault(); window.location = a.getAttribute('href'); });
        });
        return;
      }

      var cancelBtn = modal.querySelector('.btn-logout-cancel');
      var confirmBtn = modal.querySelector('.btn-logout-confirm');

      function openModalFor(href) {
        if (confirmBtn && href) confirmBtn.setAttribute('href', href);
        modal.style.display = 'flex';
      }

      function closeModal() { modal.style.display = 'none'; }

      if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', function(ev){ if (ev.target === modal) closeModal(); });
      window.addEventListener('keydown', function(ev){ if (ev.key === 'Escape') closeModal(); });

      logoutLinks.forEach(function(a){
        if (a.classList && a.classList.contains('btn-logout-confirm')) return;
        a.addEventListener('click', function(e){ e.preventDefault(); openModalFor(a.getAttribute('href')); });
      });
    })();
  </script>
</body>
</html>